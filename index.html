<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Snapchat Overlay Video Export</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#eee; text-align:center; padding:20px; }
  .stage { max-width: 400px; margin:auto; position:relative; }
  video { width:100%; border:2px solid #333; }
  .overlay {
    position:absolute; left:0; width:100%; height:90px;
    background:rgba(0,0,0,0.5); color:#fff;
    display:flex; align-items:center; justify-content:center;
    font-size:24px; font-weight:600;
    cursor:ns-resize; user-select:none;
  }
  .overlay[contenteditable="true"] { outline:none; cursor:text; }
  #progress { margin-top:20px; }
</style>
</head>
<body>
  <h1>üé• Overlay estilo Snapchat</h1>
  <input type="file" id="uploader" accept="video/*"><br><br>
  <div class="stage">
    <video id="preview" controls></video>
    <div id="overlay" class="overlay" contenteditable="true">Texto Snapchat üòé</div>
  </div>
  <br>
  <button id="exportBtn">‚¨áÔ∏è Exportar video con overlay</button>
  <div id="progress"></div>

  <!-- FFmpeg.wasm -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
  <script>
    const uploader = document.getElementById('uploader');
    const preview = document.getElementById('preview');
    const overlay = document.getElementById('overlay');
    const exportBtn = document.getElementById('exportBtn');
    const progress = document.getElementById('progress');

    let videoFileName = null;

    uploader.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        preview.src = url;
        videoFileName = file.name;
      }
    });

    // permitir mover la franja solo arriba/abajo
    let dragging = false, startY=0, origTop=0;
    overlay.addEventListener('mousedown', e=>{
      if (e.detail === 2) return; // doble click = editar texto
      dragging = true;
      startY = e.clientY;
      origTop = overlay.offsetTop;
      e.preventDefault();
    });
    window.addEventListener('mousemove', e=>{
      if (!dragging) return;
      let dy = e.clientY - startY;
      let newTop = origTop + dy;
      newTop = Math.max(0, Math.min(newTop, preview.clientHeight - overlay.clientHeight));
      overlay.style.top = newTop + 'px';
    });
    window.addEventListener('mouseup', ()=> dragging=false);

    // Exportar con ffmpeg.wasm
    exportBtn.addEventListener('click', async () => {
      if (!videoFileName) {
        alert("Primero carg√° un video"); return;
      }
      const { createFFmpeg, fetchFile } = FFmpeg;
      const ffmpeg = createFFmpeg({ log: true, progress: ({ratio})=>{
        progress.textContent = "Procesando: " + Math.round(ratio*100) + "%";
      }});
      await ffmpeg.load();

      const file = uploader.files[0];
      await ffmpeg.FS('writeFile', videoFileName, await fetchFile(file));

      // calcular posici√≥n Y de la franja en % relativo
      const fracY = overlay.offsetTop / preview.clientHeight;
      const fracH = overlay.clientHeight / preview.clientHeight;
      const text = overlay.innerText.replace(/:/g, '\\:'); // escapar ":" para ffmpeg

      // filtro drawbox + drawtext
      const filter = `drawbox=x=0:y=ih*${fracY}:w=iw:h=ih*${fracH}:color=black@0.5:t=fill,drawtext=text='${text}':fontcolor=white:fontsize=32:x=(w-text_w)/2:y=(h-text_h)/2+ih*${fracY}`;

      await ffmpeg.run(
        '-i', videoFileName,
        '-vf', filter,
        '-c:a', 'copy',
        'output.mp4'
      );

      const data = ffmpeg.FS('readFile', 'output.mp4');
      const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
      const a = document.createElement('a');
      a.href = url;
      a.download = 'overlay.mp4';
      a.click();
      progress.textContent = "‚úÖ Listo";
    });
  </script>
</body>
</html>
